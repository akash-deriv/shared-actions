name: ðŸ“š DocSync AI - Documentation Sync

on:
  workflow_call:
    inputs:
      base_branch:
        description: 'Base branch for documentation PR (e.g., master or main)'
        required: false
        default: 'master'
        type: string
      pr_labels:
        description: 'Comma-separated labels for the documentation PR'
        required: false
        default: 'documentation,automated'
        type: string
      slack_webhook_url:
        description: 'Slack webhook URL for notifications (optional, can use secret instead)'
        required: false
        default: ''
        type: string
      slack_bot_token:
        description: 'Slack OAuth Bot Token (xoxb-...) for notifications'
        required: false
        default: ''
        type: string
      slack_channel_id:
        description: 'Slack channel ID (C...) for notifications'
        required: false
        default: ''
        type: string
      repository_owner:
        description: 'Repository owner Slack user ID for Slack mentions'
        required: false
        default: ''
        type: string
      trigger_type:
        description: 'Trigger type: "merge" for PR merge, "comment" for PR comment'
        required: false
        default: 'merge'
        type: string
      comment_body:
        description: 'Comment body (only for comment trigger, must start with "docsync:")'
        required: false
        default: ''
        type: string
      comment_pr_number:
        description: 'PR number where comment was made (only for comment trigger)'
        required: false
        default: ''
        type: string
    secrets:
      DOCSYNC_GITHUB_TOKEN:
        description: 'GitHub PAT for PR creation (repo-specific, needs repo and pull_requests permissions)'
        required: true
      DOCSYNC_ANTHROPIC_API_KEY:
        description: 'Anthropic API key for Claude AI'
        required: true
      DOCSYNC_SLACK_WEBHOOK:
        description: 'Slack webhook URL for notifications (optional if provided via input)'
        required: false
      DOCSYNC_SLACK_BOT_TOKEN:
        description: 'Slack OAuth Bot Token for notifications'
        required: false
  schedule:
    - cron: '0 11 * * 3'  # Every Wednesday at 11:00 AM UTC
  workflow_dispatch:  # Allow manual testing

concurrency:
  group: docsync-ai-${{ github.repository }}
  cancel-in-progress: false

jobs:
  weekly-aggregate-sync:
    name: ðŸ“… Weekly Documentation Aggregation
    runs-on: ubuntu-latest

    # Only run on schedule trigger
    if: github.event_name == 'schedule'

    permissions:
      contents: write
      pull-requests: write

    outputs:
      doc_pr_created: ${{ steps.docsync-aggregate.outputs.doc_pr_created }}
      doc_pr_number: ${{ steps.docsync-aggregate.outputs.doc_pr_number }}
      doc_pr_url: ${{ steps.docsync-aggregate.outputs.doc_pr_url }}

    steps:
      - name: ðŸ” Get Last Workflow Run Timestamp
        id: last-run
        env:
          GH_TOKEN: ${{ secrets.DOCSYNC_GITHUB_TOKEN }}
        run: |
          set -e

          # Get last successful run timestamp
          LAST_RUN=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/workflows/docsync-ai.yml/runs?status=success&per_page=1" \
            --jq '.workflow_runs[0].created_at // empty' 2>/dev/null || echo "")

          if [ -z "$LAST_RUN" ]; then
            # No previous run, default to 7 days ago
            SINCE_DATE=$(date -u -d '7 days ago' "+%Y-%m-%dT%H:%M:%SZ")
            echo "â„¹ï¸ No previous run found, using 7 days ago" >> $GITHUB_STEP_SUMMARY
          else
            SINCE_DATE=$(date -u -d "$LAST_RUN" "+%Y-%m-%dT%H:%M:%SZ")
            echo "âœ… Using last run date: $SINCE_DATE" >> $GITHUB_STEP_SUMMARY
          fi

          echo "since_date=$SINCE_DATE" >> $GITHUB_OUTPUT
          echo "until_date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: ðŸ“‹ Fetch Merged PRs Since Last Run
        id: fetch-prs
        env:
          GH_TOKEN: ${{ secrets.DOCSYNC_GITHUB_TOKEN }}
          SINCE_DATE: ${{ steps.last-run.outputs.since_date }}
        run: |
          set -e

          echo "## ðŸ“‹ Fetching Merged PRs" >> $GITHUB_STEP_SUMMARY

          # Fetch all merged PRs within date range, excluding DocSync PRs
          MERGED_PRS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/pulls?state=closed&per_page=100&sort=updated&direction=desc" \
            --jq "[.[] | select(
              .merged_at != null and
              .merged_at >= \"$SINCE_DATE\" and
              (.title | contains(\"DocSync AI\") | not) and
              ([.labels[].name] | any(. == \"automated\") | not)
            ) | {
              number: .number,
              title: .title,
              body: .body,
              merged_at: .merged_at,
              author: .user.login
            }]" 2>&1)

          # Validate response
          if ! echo "$MERGED_PRS" | jq empty 2>/dev/null; then
            echo "âŒ Failed to parse PR data" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          PR_COUNT=$(echo "$MERGED_PRS" | jq 'length')
          echo "ðŸ“Š Found $PR_COUNT merged PRs since last run" >> $GITHUB_STEP_SUMMARY

          if [ "$PR_COUNT" -eq 0 ]; then
            echo "skip_processing=true" >> $GITHUB_OUTPUT
            echo "âœ… No PRs to process" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Store PRs as JSON for next step
          echo "merged_prs_json<<EOF" >> $GITHUB_OUTPUT
          echo "$MERGED_PRS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "skip_processing=false" >> $GITHUB_OUTPUT

          # Display PR list in summary
          echo "### Merged PRs:" >> $GITHUB_STEP_SUMMARY
          echo "$MERGED_PRS" | jq -r '.[] | "- PR #\(.number): \(.title)"' >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¥ Checkout Repository
        if: steps.fetch-prs.outputs.skip_processing != 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.DOCSYNC_GITHUB_TOKEN }}
          ref: ${{ inputs.base_branch || 'master' }}
          fetch-depth: 0

      - name: ðŸ¤– Run DocSync AI Action (Aggregate Mode)
        id: docsync-aggregate
        if: steps.fetch-prs.outputs.skip_processing != 'true'
        uses: deriv-com/shared-actions/.github/actions/docsync_ai@master
        with:
          github_token: ${{ secrets.DOCSYNC_GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.DOCSYNC_ANTHROPIC_API_KEY }}
          repository: ${{ github.repository }}
          base_branch: ${{ inputs.base_branch || 'master' }}
          pr_labels: ${{ inputs.pr_labels || 'documentation,automated' }}
          is_aggregate_mode: true
          aggregated_prs_json: ${{ steps.fetch-prs.outputs.merged_prs_json }}

      - name: ðŸ“¢ Send Slack Notification
        if: steps.docsync-aggregate.outputs.doc_pr_created == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.DOCSYNC_SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ inputs.slack_channel_id }}
          REPO_OWNER: ${{ inputs.repository_owner }}
          DOC_PR_URL: ${{ steps.docsync-aggregate.outputs.doc_pr_url }}
          DOC_PR_NUMBER: ${{ steps.docsync-aggregate.outputs.doc_pr_number }}
        run: |
          set -e

          # Skip if no Slack configuration
          if [ -z "$SLACK_BOT_TOKEN" ] || [ -z "$SLACK_CHANNEL_ID" ]; then
            echo "â„¹ï¸ No Slack configuration - skipping notification" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Sanitize inputs
          REPO_OWNER_CLEAN=$(echo "$REPO_OWNER" | tr -d '\000-\037' | head -c 50)
          DOC_PR_URL_CLEAN=$(echo "$DOC_PR_URL" | head -c 500)

          # Validate PR number
          if ! [[ "$DOC_PR_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "âš ï¸ Invalid PR number, skipping notification" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Calculate PR count from JSON
          PR_COUNT=$(echo '${{ steps.fetch-prs.outputs.merged_prs_json }}' | jq 'length' 2>/dev/null || echo "0")

          # Get PR list for display
          PR_LIST=$(echo '${{ steps.fetch-prs.outputs.merged_prs_json }}' | jq -r '[.[] | "PR #\(.number): \(.title)"] | join("\n")' | head -c 500)

          # Create Slack payload
          PAYLOAD=$(jq -n \
            --arg channel "$SLACK_CHANNEL_ID" \
            --arg owner "$REPO_OWNER_CLEAN" \
            --arg repo "${{ github.repository }}" \
            --arg pr_url "$DOC_PR_URL_CLEAN" \
            --arg pr_num "$DOC_PR_NUMBER" \
            --arg pr_count "$PR_COUNT" \
            --arg pr_list "$PR_LIST" \
            '{
              "channel": $channel,
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<@\($owner)> :book: *Weekly Documentation Update Ready*\n*<\($pr_url)|PR #\($pr_num)>* in `\($repo)`"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Documentation updated based on *\($pr_count)* merged PRs this week:\n```\n\($pr_list)\n```"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ðŸ¤– DocSync AI | <\($pr_url)|Review documentation updates>"
                    }
                  ]
                }
              ]
            }')

          # Send notification
          RESPONSE=$(curl -s \
            -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          # Validate response
          if echo "$RESPONSE" | jq -e '.ok == true' > /dev/null 2>&1; then
            echo "ðŸ“¢ Slack notification sent successfully" >> $GITHUB_STEP_SUMMARY
          else
            ERROR=$(echo "$RESPONSE" | jq -r '.error // "unknown"')
            echo "âš ï¸ Warning: Failed to send Slack notification: $ERROR" >> $GITHUB_STEP_SUMMARY
          fi

  sync-documentation:
    name: ðŸ“š Sync Documentation
    runs-on: ubuntu-latest

    # Only run on PR merge, not on schedule
    if: |
      github.event_name != 'schedule' &&
      github.event.pull_request.merged == true &&
      !contains(github.event.pull_request.title, 'DocSync AI') &&
      !contains(github.event.pull_request.labels.*.name, 'automated')

    permissions:
      contents: write
      pull-requests: write

    outputs:
      doc_pr_created: ${{ steps.docsync.outputs.doc_pr_created }}
      doc_pr_number: ${{ steps.docsync.outputs.doc_pr_number }}
      doc_pr_url: ${{ steps.docsync.outputs.doc_pr_url }}

    env:
      BASE_BRANCH: ${{ inputs.base_branch }}
      PR_LABELS: ${{ inputs.pr_labels }}
      SLACK_WEBHOOK: ${{ inputs.slack_webhook_url || secrets.DOCSYNC_SLACK_WEBHOOK }}
      REPO_OWNER: ${{ inputs.repository_owner }}

    steps:
      - name: ðŸ” Debug - Workflow Trigger Info
        run: |
          echo "## ðŸ” Workflow Trigger Info" >> $GITHUB_STEP_SUMMARY
          echo "Event: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Action: ${{ github.event.action }}" >> $GITHUB_STEP_SUMMARY
          echo "PR Merged: ${{ github.event.pull_request.merged }}" >> $GITHUB_STEP_SUMMARY
          echo "PR Number: ${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "PR Title: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "Base Branch: ${{ inputs.base_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.DOCSYNC_GITHUB_TOKEN }}
          ref: ${{ inputs.base_branch }}

      - name: ðŸ¤– Run DocSync AI Action
        id: docsync
        uses: deriv-com/shared-actions/.github/actions/docsync_ai@master
        with:
          github_token: ${{ secrets.DOCSYNC_GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.DOCSYNC_ANTHROPIC_API_KEY }}
          repository: ${{ github.repository }}
          pr_number: ${{ github.event.pull_request.number }}
          pr_title: ${{ github.event.pull_request.title }}
          pr_body: ${{ github.event.pull_request.body }}
          base_branch: ${{ inputs.base_branch }}
          pr_labels: ${{ inputs.pr_labels }}

      - name: ðŸ“¢ Send Slack Notification - Documentation PR Created
        if: steps.docsync.outputs.doc_pr_created == 'true' && env.SLACK_WEBHOOK != ''
        env:
          DOC_PR_NUMBER: ${{ steps.docsync.outputs.doc_pr_number }}
          DOC_PR_URL: ${{ steps.docsync.outputs.doc_pr_url }}
          MERGED_PR_NUMBER: ${{ github.event.pull_request.number }}
          MERGED_PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          set -e

          # Validate webhook URL format
          if [[ ! "$SLACK_WEBHOOK" =~ ^https://hooks\.slack\.com/services/ ]]; then
            echo "âš ï¸ Warning: Invalid Slack webhook URL format, skipping notification" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Sanitize inputs for Slack message
          MERGED_PR_TITLE_CLEAN=$(echo "$MERGED_PR_TITLE" | tr -d '\000-\037' | head -c 200)
          DOC_PR_URL_CLEAN=$(echo "$DOC_PR_URL" | head -c 500)

          # Validate PR numbers
          if ! [[ "$DOC_PR_NUMBER" =~ ^[0-9]+$ ]] || ! [[ "$MERGED_PR_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "âš ï¸ Warning: Invalid PR numbers, skipping notification" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Format repository owner mention for Slack
          OWNER_MENTION=""
          if [ -n "$REPO_OWNER" ]; then
            # Sanitize owner mention
            REPO_OWNER_CLEAN=$(echo "$REPO_OWNER" | tr -d '\000-\037' | head -c 50)
            OWNER_MENTION="<@$REPO_OWNER_CLEAN> "
          fi

          # Create Slack payload safely using jq
          SLACK_PAYLOAD=$(jq -n \
            --arg owner "$OWNER_MENTION" \
            --arg repo "${{ github.repository }}" \
            --arg doc_pr_url "$DOC_PR_URL_CLEAN" \
            --arg doc_pr_num "$DOC_PR_NUMBER" \
            --arg merged_pr_num "$MERGED_PR_NUMBER" \
            --arg merged_pr_title "$MERGED_PR_TITLE_CLEAN" \
            '{
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "\($owner):book: *Documentation Update Ready*\n*<\($doc_pr_url)|PR #\($doc_pr_num)>* in `\($repo)`"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Documentation has been automatically updated based on:\n- *PR #\($merged_pr_num)*: \($merged_pr_title)"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ðŸ¤– DocSync AI | <\($doc_pr_url)|Review documentation updates>"
                    }
                  ]
                }
              ]
            }')

          # Create temporary file for response
          TEMP_RESPONSE=$(mktemp)
          trap "rm -f '$TEMP_RESPONSE'" EXIT

          # Send Slack notification with error handling
          HTTP_CODE=$(curl -s -w "%{http_code}" -o "$TEMP_RESPONSE" \
            -X POST "$SLACK_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$SLACK_PAYLOAD")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "ðŸ“¢ Slack notification sent successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Warning: Failed to send Slack notification (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
            # Don't fail the workflow on notification failure
          fi

      - name: âœ… Summary
        if: always()
        env:
          JOB_STATUS: ${{ job.status }}
          DOC_PR_CREATED: ${{ steps.docsync.outputs.doc_pr_created }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Source PR | #${{ github.event.pull_request.number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation PR Created | ${DOC_PR_CREATED:-false} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | $JOB_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Base Branch | $BASE_BRANCH |" >> $GITHUB_STEP_SUMMARY

  update-from-comment:
    name: ðŸ’¬ Update Documentation from Comment
    runs-on: ubuntu-latest

    # Only run when trigger_type is 'comment'
    if: inputs.trigger_type == 'comment'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ” Debug - Comment Trigger Info
        run: |
          echo "## ðŸ” Comment Trigger Info" >> $GITHUB_STEP_SUMMARY
          echo "Trigger Type: ${{ inputs.trigger_type }}" >> $GITHUB_STEP_SUMMARY
          echo "PR Number: ${{ inputs.comment_pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ¤– Run DocSync AI Comment Action
        id: docsync-comment
        uses: deriv-com/shared-actions/.github/actions/docsync_ai_comment@master
        with:
          github_token: ${{ secrets.DOCSYNC_GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.DOCSYNC_ANTHROPIC_API_KEY }}
          repository: ${{ github.repository }}
          pr_number: ${{ inputs.comment_pr_number }}
          comment_body: ${{ inputs.comment_body }}
          base_branch: ${{ inputs.base_branch }}
          slack_bot_token: ${{ secrets.DOCSYNC_SLACK_BOT_TOKEN }}
          slack_channel_id: ${{ inputs.slack_channel_id }}
          repository_owner: ${{ inputs.repository_owner }}

      - name: âœ… Summary
        if: always()
        env:
          JOB_STATUS: ${{ job.status }}
          UPDATED: ${{ steps.docsync-comment.outputs.updated }}
          VALID: ${{ steps.docsync-comment.outputs.suggestion_valid }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| PR Number | #${{ inputs.comment_pr_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Valid Comment | ${VALID:-false} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation Updated | ${UPDATED:-false} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | $JOB_STATUS |" >> $GITHUB_STEP_SUMMARY
