name: ðŸ“š DocSync AI - Documentation Sync

on:
  workflow_call:
    inputs:
      base_branch:
        description: 'Base branch for documentation PR (e.g., master or main)'
        required: false
        default: 'master'
        type: string
      pr_labels:
        description: 'Comma-separated labels for the documentation PR'
        required: false
        default: 'documentation,automated'
        type: string
      slack_webhook_url:
        description: 'Slack webhook URL for notifications (optional, legacy support)'
        required: false
        default: ''
        type: string
      repository_owner:
        description: 'Repository owner name for Slack notifications (legacy, use slack_user_id instead)'
        required: false
        default: ''
        type: string
      slack_channel_id:
        description: 'Slack channel ID for notifications (e.g., C01234567)'
        required: false
        default: ''
        type: string
      slack_user_id:
        description: 'Slack user ID to mention in notifications (e.g., U01234567)'
        required: false
        default: ''
        type: string
      trigger_type:
        description: 'Trigger type: "merge" for PR merge, "comment" for PR comment'
        required: false
        default: 'merge'
        type: string
      comment_body:
        description: 'Comment body (only for comment trigger, must start with "@docbot" or "docsync:")'
        required: false
        default: ''
        type: string
      comment_pr_number:
        description: 'PR number where comment was made (only for comment trigger)'
        required: false
        default: ''
        type: string
    secrets:
      DOCSYNC_GITHUB_TOKEN:
        description: 'GitHub PAT for PR creation (repo-specific, needs repo and pull_requests permissions)'
        required: true
      DOCSYNC_ANTHROPIC_API_KEY:
        description: 'Anthropic API key for Claude AI'
        required: true
      DOCSYNC_SLACK_WEBHOOK:
        description: 'Slack webhook URL for notifications (optional, legacy support)'
        required: false
      SLACK_OAUTH_TOKEN:
        description: 'Slack OAuth token from shared-actions repo (automatically provided)'
        required: false

concurrency:
  group: docsync-ai-${{ github.repository }}
  cancel-in-progress: false

jobs:
  sync-documentation:
    name: ðŸ“š Sync Documentation
    runs-on: ubuntu-latest

    # Only run when a PR is merged to the base branch
    if: github.event.pull_request.merged == true

    permissions:
      contents: write
      pull-requests: write

    outputs:
      doc_pr_created: ${{ steps.docsync.outputs.doc_pr_created }}
      doc_pr_number: ${{ steps.docsync.outputs.doc_pr_number }}
      doc_pr_url: ${{ steps.docsync.outputs.doc_pr_url }}

    env:
      BASE_BRANCH: ${{ inputs.base_branch }}
      PR_LABELS: ${{ inputs.pr_labels }}
      SLACK_WEBHOOK: ${{ inputs.slack_webhook_url || secrets.DOCSYNC_SLACK_WEBHOOK }}
      SLACK_OAUTH_TOKEN: ${{ secrets.SLACK_OAUTH_TOKEN }}
      SLACK_CHANNEL_ID: ${{ inputs.slack_channel_id }}
      SLACK_USER_ID: ${{ inputs.slack_user_id }}
      REPO_OWNER: ${{ inputs.repository_owner }}

    steps:
      - name: ðŸ” Debug - Workflow Trigger Info
        run: |
          echo "## ðŸ” Workflow Trigger Info" >> $GITHUB_STEP_SUMMARY
          echo "Event: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Action: ${{ github.event.action }}" >> $GITHUB_STEP_SUMMARY
          echo "PR Merged: ${{ github.event.pull_request.merged }}" >> $GITHUB_STEP_SUMMARY
          echo "PR Number: ${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "PR Title: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "Base Branch: ${{ inputs.base_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.DOCSYNC_GITHUB_TOKEN }}
          ref: ${{ inputs.base_branch }}

      - name: ðŸ¤– Run DocSync AI Action
        id: docsync
        uses: akash-deriv/shared-actions/.github/actions/docsync_ai@master
        with:
          github_token: ${{ secrets.DOCSYNC_GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.DOCSYNC_ANTHROPIC_API_KEY }}
          repository: ${{ github.repository }}
          pr_number: ${{ github.event.pull_request.number }}
          pr_title: ${{ github.event.pull_request.title }}
          pr_body: ${{ github.event.pull_request.body }}
          base_branch: ${{ inputs.base_branch }}
          pr_labels: ${{ inputs.pr_labels }}

      - name: ðŸ“¢ Send Slack Notification - Documentation PR Created
        if: steps.docsync.outputs.doc_pr_created == 'true' && (env.SLACK_OAUTH_TOKEN != '' || env.SLACK_WEBHOOK != '')
        env:
          DOC_PR_NUMBER: ${{ steps.docsync.outputs.doc_pr_number }}
          DOC_PR_URL: ${{ steps.docsync.outputs.doc_pr_url }}
          MERGED_PR_NUMBER: ${{ github.event.pull_request.number }}
          MERGED_PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          set -e

          # Sanitize inputs for Slack message
          MERGED_PR_TITLE_CLEAN=$(echo "$MERGED_PR_TITLE" | tr -d '\000-\037' | head -c 200)
          DOC_PR_URL_CLEAN=$(echo "$DOC_PR_URL" | head -c 500)

          # Validate PR numbers
          if ! [[ "$DOC_PR_NUMBER" =~ ^[0-9]+$ ]] || ! [[ "$MERGED_PR_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "âš ï¸ Warning: Invalid PR numbers, skipping notification" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Determine which Slack method to use
          USE_OAUTH=false
          if [ -n "$SLACK_OAUTH_TOKEN" ] && [ -n "$SLACK_CHANNEL_ID" ]; then
            USE_OAUTH=true
            echo "Using Slack OAuth token method" >> $GITHUB_STEP_SUMMARY
          elif [ -n "$SLACK_WEBHOOK" ]; then
            echo "Using Slack webhook method (legacy)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Warning: No Slack configuration found, skipping notification" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Format user mention for Slack
          USER_MENTION=""
          if [ -n "$SLACK_USER_ID" ]; then
            USER_MENTION="<@$SLACK_USER_ID> "
          elif [ -n "$REPO_OWNER" ]; then
            # Legacy support: use REPO_OWNER if provided
            REPO_OWNER_CLEAN=$(echo "$REPO_OWNER" | tr -d '\000-\037' | head -c 50)
            USER_MENTION="<@$REPO_OWNER_CLEAN> "
          fi

          # Create temporary file for response
          TEMP_RESPONSE=$(mktemp)
          trap "rm -f '$TEMP_RESPONSE'" EXIT

          if [ "$USE_OAUTH" = true ]; then
            # Use Slack OAuth token with chat.postMessage API (simplified payload like Python script)
            MESSAGE_TEXT="${USER_MENTION}ðŸ“š *Documentation Update Ready*
            *PR #${DOC_PR_NUMBER}* in \`${{ github.repository }}\`

            Documentation has been automatically updated based on:
            â€¢ *PR #${MERGED_PR_NUMBER}*: ${MERGED_PR_TITLE_CLEAN}

            ðŸ”— Review: ${DOC_PR_URL_CLEAN}

            ðŸ¤– DocSync AI"

            # Create simple JSON payload (matching Python script structure)
            SLACK_PAYLOAD=$(jq -n \
              --arg channel "$SLACK_CHANNEL_ID" \
              --arg text "$MESSAGE_TEXT" \
              '{channel: $channel, text: $text}')

            # Send message using Slack API
            HTTP_CODE=$(curl -s -w "%{http_code}" -o "$TEMP_RESPONSE" \
              -X POST "https://slack.com/api/chat.postMessage" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $SLACK_OAUTH_TOKEN" \
              -d "$SLACK_PAYLOAD")

            # Check response
            if [ "$HTTP_CODE" = "200" ]; then
              API_OK=$(cat "$TEMP_RESPONSE" | jq -r '.ok' 2>/dev/null || echo "false")
              if [ "$API_OK" = "true" ]; then
                echo "ðŸ“¢ Slack notification sent successfully via OAuth" >> $GITHUB_STEP_SUMMARY
              else
                API_ERROR=$(cat "$TEMP_RESPONSE" | jq -r '.error' 2>/dev/null || echo "unknown")
                echo "âš ï¸ Warning: Slack API error: $API_ERROR" >> $GITHUB_STEP_SUMMARY
                echo "Response: $(cat "$TEMP_RESPONSE")" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âš ï¸ Warning: Failed to send Slack notification (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
              echo "Response: $(cat "$TEMP_RESPONSE")" >> $GITHUB_STEP_SUMMARY
            fi
          else
            # Use legacy webhook method
            # Validate webhook URL format
            if [[ ! "$SLACK_WEBHOOK" =~ ^https://hooks\.slack\.com/services/ ]]; then
              echo "âš ï¸ Warning: Invalid Slack webhook URL format, skipping notification" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi

            # Create simple text message for webhook
            MESSAGE_TEXT="${USER_MENTION}ðŸ“š *Documentation Update Ready*
            *PR #${DOC_PR_NUMBER}* in \`${{ github.repository }}\`

            Documentation has been automatically updated based on:
            â€¢ *PR #${MERGED_PR_NUMBER}*: ${MERGED_PR_TITLE_CLEAN}

            ðŸ”— Review: ${DOC_PR_URL_CLEAN}

            ðŸ¤– DocSync AI"

            SLACK_PAYLOAD=$(jq -n --arg text "$MESSAGE_TEXT" '{text: $text}')

            # Send notification via webhook
            HTTP_CODE=$(curl -s -w "%{http_code}" -o "$TEMP_RESPONSE" \
              -X POST "$SLACK_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d "$SLACK_PAYLOAD")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "ðŸ“¢ Slack notification sent successfully via webhook" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Warning: Failed to send Slack notification (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: âœ… Summary
        if: always()
        env:
          JOB_STATUS: ${{ job.status }}
          DOC_PR_CREATED: ${{ steps.docsync.outputs.doc_pr_created }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Source PR | #${{ github.event.pull_request.number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation PR Created | ${DOC_PR_CREATED:-false} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | $JOB_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Base Branch | $BASE_BRANCH |" >> $GITHUB_STEP_SUMMARY

  update-from-comment:
    name: ðŸ’¬ Update Documentation from Comment
    runs-on: ubuntu-latest

    # Only run when trigger_type is 'comment'
    if: inputs.trigger_type == 'comment'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ” Debug - Comment Trigger Info
        run: |
          echo "## ðŸ” Comment Trigger Info" >> $GITHUB_STEP_SUMMARY
          echo "Trigger Type: ${{ inputs.trigger_type }}" >> $GITHUB_STEP_SUMMARY
          echo "PR Number: ${{ inputs.comment_pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ¤– Run DocSync AI Comment Action
        id: docsync-comment
        uses: akash-deriv/shared-actions/.github/actions/docsync_ai_comment@master
        with:
          github_token: ${{ secrets.DOCSYNC_GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.DOCSYNC_ANTHROPIC_API_KEY }}
          repository: ${{ github.repository }}
          pr_number: ${{ inputs.comment_pr_number }}
          comment_body: ${{ inputs.comment_body }}
          base_branch: ${{ inputs.base_branch }}

      - name: âœ… Summary
        if: always()
        env:
          JOB_STATUS: ${{ job.status }}
          UPDATED: ${{ steps.docsync-comment.outputs.updated }}
          VALID: ${{ steps.docsync-comment.outputs.suggestion_valid }}
          IS_DOCSYNC_PR: ${{ steps.docsync-comment.outputs.is_docsync_pr }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| PR Number | #${{ inputs.comment_pr_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Valid Comment | ${VALID:-false} |" >> $GITHUB_STEP_SUMMARY
          echo "| Is DocSync PR | ${IS_DOCSYNC_PR:-false} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation Updated | ${UPDATED:-false} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | $JOB_STATUS |" >> $GITHUB_STEP_SUMMARY

